# Dev Notes - 2025-10-03

## Summary
- Fixed login and API routing by correcting Nginx config to route all `/api/` (including `/api/auth/`) to backend on port 8001.
- Resolved frontend build issues due to disk space; pruned caches and verified services.
- Brought up all containers: backend, frontend, postgres, redis, worker, beat.
- Verified authentication flow end-to-end; obtained access/refresh tokens.
- Identified and reset stuck WooCommerce jobs; reran syncs successfully.
- Implemented timezone-aware datetime parsing for WooCommerce order fields to eliminate naive datetime warnings.

## Key Changes
- Nginx `veveve.dk` config:
  - Removed `location ^~ /api/auth/` and `/api/data/` blocks to frontend.
  - Kept a single `location /api/` proxy to backend `http://localhost:8001/api/`.
- Backend (Django):
  - `backend/woocommerce/tasks.py`: added `parse_aware` to parse ISO/Woo timestamps into aware UTC datetimes.
  - Updated fields: `order_date`, `paid_date`, `date_created`, `date_modified`, `date_completed`, `attribution_session_start_time`.

## Commands Executed
- Container health and restart
```bash
cd /opt/vvv-frontpage
docker-compose ps
docker-compose up -d backend worker beat
```
- Nginx
```bash
sudo nginx -t
sudo systemctl reload nginx
```
- Auth tests
```bash
curl -v -X POST https://veveve.dk/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"andreas@veveve.dk","password":"******"}'
```
- Token capture and syncs
```bash
TOKEN=$(curl -s -X POST https://veveve.dk/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"andreas@veveve.dk","password":"******"}' | jq -r .access_token)

# Pipeline sync (Cordyfresh example)
curl -X POST https://veveve.dk/api/pipelines/1/sync_now/ \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json"

# Woo config syncs
a) Dupskoshoppen (config 3)
curl -X POST https://veveve.dk/api/woocommerce/configs/3/sync_now/ \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"job_type":"manual_sync"}'

b) Porsa (config 2)
curl -X POST https://veveve.dk/api/woocommerce/configs/2/sync_now/ \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"job_type":"manual_sync"}'

# Optional: date-ranged sync
curl -X POST https://veveve.dk/api/woocommerce/configs/3/sync_now/ \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"job_type":"manual_sync","start_date":"2025-09-01","end_date":"2025-10-03"}'
```
- Job monitoring
```bash
curl -H "Authorization: Bearer $TOKEN" https://veveve.dk/api/woocommerce/jobs/
docker logs -f vvv-frontpage-worker-1
```

## Results
- Auth endpoint working; returns valid access and refresh tokens (HTTP 200).
- Pipelines endpoint lists all pipelines.
- Cordyfresh sync_now completed (e.g., 168 orders processed).
- Dupskoshoppen sync (manual_sync) started and completed successfully (e.g., 1045 orders created on backfill).
- Porsa sync started via Celery and is progressing.
- Celery worker and beat running and connected to Redis.
- Backend stable (Gunicorn workers up), frontend serving via Next.js.

## Post-Fix Observations
- Previous 500/502 issues due to misrouted `/api/auth/` and worker timeouts are resolved.
- Naive datetime warnings removed by timezone-aware parsing.
- Disk usage improved after cleanup; keep periodic pruning in mind.

## Next Actions
- Verify analytics UI reflects newly synced orders for Dupskoshoppen and Porsa.
- Schedule regular syncs (via beat) and monitor job durations for large stores.
- Consider adding rate limiting/backoff for Woo API and pagination protections.
- Keep Nginx config under version control and document routing rules.

