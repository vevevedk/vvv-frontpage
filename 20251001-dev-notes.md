# Dev Notes - 2025-10-01

## Issue Summary
**Problem**: App returning 401 authentication errors when trying to log in, followed by 502 errors on 2 out of 3 WooCommerce pipelines.

## Root Cause Analysis

### 1. Authentication Issue (RESOLVED ‚úÖ)
- **Cause**: Docker prune for another app affected shared Docker resources, causing `vvv-frontpage` containers to lose environment state
- **Symptoms**: 401 "Invalid credentials" errors despite successful login at 07:15:18
- **Solution**: Fresh restart with `docker-compose up -d` reloaded environment variables properly
- **Status**: Login working again after restart

### 2. Pipeline 502 Errors (IN PROGRESS üîÑ)
- **Affected Pipelines**: 
  - Dupskoshoppen DK - WooCommerce (502 error)
  - Porsa.dk - WooCommerce (502 error)
  - Cordyfresh - WooCommerce (working fine ‚úÖ)
- **Root Cause**: Stuck pipeline jobs from worker crash earlier today
- **Evidence**: Pipeline jobs stuck in "pending" and "running" status since 09:20-09:21

## Technical Details

### Container Status
- **Backend**: `vvv-frontpage-backend-1` - Running with 3 workers (PIDs 7, 8, 9)
- **Frontend**: `vvv-frontpage-frontend-1` - Running on port 3000
- **Worker**: `vvv-frontpage-worker-1` - Running
- **Beat**: `vvv-frontpage-beat-1` - Running

### Database Models Identified
- **Pipelines**: `DataPipeline`, `PipelineJob`, `PipelineLog`, `DataQualityCheck`, `PipelineAnalytics`
- **WooCommerce**: `WooCommerceJob`, `WooCommerceOrder`, `WooCommerceOrderItem`, `WooCommerceSyncLog`, `ChannelClassification`

### Stuck Jobs Found
- **Job 7** (Dupskoshoppen): Status: pending since 09:21:37
- **Job 5** (Porsa.dk): Status: pending since 09:20:48
- **Job 9** (WooCommerce): Status: running since 09:21:37
- **Job 7** (WooCommerce): Status: running since 09:20:48

## Next Steps for Tomorrow

### Immediate Actions
1. **Reset stuck pipeline jobs** to failed status to clear the queue
2. **Monitor real-time logs** while testing sync functionality
3. **Test sync endpoint directly** via curl to isolate the issue
4. **Check Celery worker health** and task processing

### Commands to Run
```bash
# Reset stuck jobs
docker exec -it vvv-frontpage-backend-1 python manage.py shell -c "
from pipelines.models import PipelineJob
from woocommerce.models import WooCommerceJob

# Reset stuck pipeline jobs
stuck_pipeline_jobs = PipelineJob.objects.filter(status__in=['pending', 'running'])
for job in stuck_pipeline_jobs:
    job.status = 'failed'
    job.error_message = 'Job stuck due to worker restart - reset to failed'
    job.save()

# Reset stuck WooCommerce jobs
stuck_woo_jobs = WooCommerceJob.objects.filter(status__in=['pending', 'running'])
for job in stuck_woo_jobs:
    job.status = 'failed'
    job.error_message = 'Job stuck due to worker restart - reset to failed'
    job.save()
"

# Monitor logs in real-time
docker logs vvv-frontpage-backend-1 -f

# Test sync endpoint
curl -X POST http://localhost:8001/api/pipelines/1/sync/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### Additional Diagnostics
- Check gunicorn timeout settings
- Verify database connectivity
- Test Celery task creation and processing
- Check for any missing environment variables

## Environment Notes
- **Production Server**: `/opt/vvv-frontpage/`
- **Docker Compose**: Services running via `docker-compose up -d`
- **Logs Location**: `docker logs vvv-frontpage-backend-1`
- **Database**: PostgreSQL via Docker container

## Status
- ‚úÖ Authentication fixed
- üîÑ Pipeline 502 errors - needs investigation
- ‚è≥ Next session: Focus on pipeline sync functionality

