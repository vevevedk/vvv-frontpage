# Dev Notes - 2025-10-02

## Issue Summary
**Problem**: Multiple critical issues affecting application stability - frontend build failures, backend container crashes, and authentication problems.

## Root Cause Analysis

### 1. Frontend Build Failure (RESOLVED ‚úÖ)
- **Cause**: Disk space exhaustion during Docker build process
- **Symptoms**: `npm ci` failing with `ENOSPC: no space left on device` error
- **Solution**: Server restart + Docker cleanup + successful rebuild
- **Status**: Frontend rebuilt with correct environment variables

### 2. Backend Container Crashes (IN PROGRESS üîÑ)
- **Cause**: Gunicorn workers crashing immediately after startup
- **Symptoms**: 
  - Workers start but immediately exit
  - No processes listening on port 8000
  - 500/502 errors from frontend
- **Evidence**: `ps aux | grep gunicorn` returns empty, `netstat` shows no port 8000 binding
- **Status**: Workers start but crash silently - needs investigation

### 3. ALLOWED_HOSTS Configuration (RESOLVED ‚úÖ)
- **Cause**: Django rejecting requests from server IP `209.38.98.109:8001`
- **Symptoms**: `Invalid HTTP_HOST header` errors in logs
- **Solution**: Server IP already in ALLOWED_HOSTS: `['localhost', '127.0.0.1', '0.0.0.0', 'backend', 'veveve.dk', 'www.veveve.dk', '209.38.98.109']`
- **Status**: Configuration correct, not the root cause

## Technical Details

### Container Status (Current)
- **Backend**: `vvv-frontpage-backend-1` - Running but workers crashing
- **Frontend**: `vvv-frontpage-frontend-1` - Running on port 3000
- **Postgres**: `vvv-frontpage-postgres-1` - Running
- **Redis**: `vvv-frontpage-redis-1` - Running
- **Worker**: `vvv-frontpage-worker-1` - Status unknown
- **Beat**: `vvv-frontpage-beat-1` - Status unknown

### Frontend Environment Fix
- **Issue**: Frontend was calling `localhost:8000` instead of production API
- **Solution**: Updated `frontend.Dockerfile` with `NEXT_PUBLIC_API_URL=https://veveve.dk/api`
- **Status**: Environment variable baked into build successfully

### Backend Worker Investigation
- **Gunicorn Process**: Master process starts but workers exit immediately
- **No Error Logs**: Workers crash silently without error messages
- **Port Binding**: No process listening on port 8000 despite Gunicorn claiming to listen
- **Database**: Connection works fine (`DB connection OK`)

## Commands Executed Today

### Docker Cleanup
```bash
# Server restart due to disk space
docker builder prune -af
docker system prune -af --volumes
```

### Frontend Rebuild
```bash
cd /opt/vvv-frontpage
docker-compose build --no-cache frontend
docker-compose up -d frontend
```

### Backend Diagnostics
```bash
# Check container status
docker-compose ps

# Check worker processes
docker exec vvv-frontpage-backend-1 ps aux | grep gunicorn

# Check port binding
docker exec vvv-frontpage-backend-1 netstat -tlnp | grep 8000

# Test API connectivity
curl -I http://localhost:8000/api/

# Check Django configuration
docker exec vvv-frontpage-backend-1 python manage.py check
```

## Previous Issues (From 2025-10-01)

### Pipeline 502 Errors (STILL PENDING)
- **Affected Pipelines**: 
  - Dupskoshoppen DK - WooCommerce (502 error)
  - Porsa.dk - WooCommerce (502 error)
  - Cordyfresh - WooCommerce (working fine ‚úÖ)
- **Root Cause**: Stuck pipeline jobs from worker crashes
- **Status**: Cannot test due to current backend issues

### Stuck Jobs Identified
- **Job 7** (Dupskoshoppen): Status: pending since 09:21:37
- **Job 5** (Porsa.dk): Status: pending since 09:20:48
- **Job 9** (WooCommerce): Status: running since 09:21:37
- **Job 7** (WooCommerce): Status: running since 09:20:48

## Next Steps (Priority Order)

### 1. Fix Backend Worker Crashes (CRITICAL)
```bash
# Try running Django directly to identify errors
docker exec vvv-frontpage-backend-1 python manage.py runserver 0.0.0.0:8000

# Check for import errors
docker exec vvv-frontpage-backend-1 python -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
import django
django.setup()
print('Django setup successful')
"

# Test Gunicorn with single worker
docker exec vvv-frontpage-backend-1 gunicorn --bind 0.0.0.0:8000 --workers 1 backend.wsgi:application
```

### 2. Reset Stuck Pipeline Jobs (HIGH)
```bash
# Reset stuck jobs once backend is working
docker exec -it vvv-frontpage-backend-1 python manage.py shell -c "
from pipelines.models import PipelineJob
from woocommerce.models import WooCommerceJob

# Reset stuck pipeline jobs
stuck_pipeline_jobs = PipelineJob.objects.filter(status__in=['pending', 'running'])
for job in stuck_pipeline_jobs:
    job.status = 'failed'
    job.error_message = 'Job stuck due to worker restart - reset to failed'
    job.save()

# Reset stuck WooCommerce jobs
stuck_woo_jobs = WooCommerceJob.objects.filter(status__in=['pending', 'running'])
for job in stuck_woo_jobs:
    job.status = 'failed'
    job.error_message = 'Job stuck due to worker restart - reset to failed'
    job.save()
"
```

### 3. Test Pipeline Sync Functionality (MEDIUM)
```bash
# Test sync endpoint once backend is stable
curl -X POST http://localhost:8000/api/pipelines/1/sync/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## Environment Notes
- **Production Server**: `/opt/vvv-frontpage/`
- **Docker Compose**: Services running via `docker-compose up -d`
- **Logs Location**: `docker logs vvv-frontpage-backend-1`
- **Database**: PostgreSQL via Docker container
- **Frontend**: Next.js with environment variables baked into build

## Status Summary
- ‚úÖ Frontend build fixed and environment variables corrected
- ‚úÖ ALLOWED_HOSTS configuration verified
- üîÑ Backend worker crashes - CRITICAL ISSUE
- ‚è≥ Pipeline 502 errors - blocked by backend issues
- ‚è≥ Authentication testing - blocked by backend issues

## Critical Path
1. **Fix backend worker crashes** (blocking everything)
2. **Test authentication** (verify login works)
3. **Reset stuck pipeline jobs** (clear the queue)
4. **Test pipeline sync** (verify 502 errors are resolved)

## Notes for Next Session
- Focus entirely on backend worker crash investigation
- Check for Django configuration errors or import issues
- Consider increasing Gunicorn timeout or memory limits
- Verify all environment variables are properly loaded
- Test with single worker first, then scale up

