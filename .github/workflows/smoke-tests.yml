name: Smoke Tests

# Comprehensive smoke tests for staging and production
# Can be run manually or as part of deployment workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
      base_url:
        description: 'Base URL to test (optional, auto-detected if not provided)'
        required: false
        type: string

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Determine Test URLs
        id: urls
        run: |
          if [ "${{ github.event.inputs.base_url }}" != "" ]; then
            BASE_URL="${{ github.event.inputs.base_url }}"
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            BASE_URL="https://staging.veveve.io"
          else
            BASE_URL="https://veveve.io"
          fi
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "Testing against: $BASE_URL"

      - name: Test Frontend Accessibility
        run: |
          BASE_URL="${{ steps.urls.outputs.base_url }}"
          echo "Testing frontend at $BASE_URL..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL" || echo "000")
          echo "Frontend HTTP status: $STATUS"
          
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Frontend is accessible (HTTP $STATUS)"
          else
            echo "âŒ Frontend health check failed (HTTP $STATUS)"
            exit 1
          fi

      - name: Test Domain Routing - veveve.io
        run: |
          echo "Testing veveve.io domain routing..."
          
          # Check if veveve.io shows English PPC content
          RESPONSE=$(curl -s https://veveve.io || echo "")
          if echo "$RESPONSE" | grep -qi "PPC\|Scale Your PPC\|Google Ads\|Facebook Ads"; then
            echo "âœ… veveve.io shows English PPC-focused content"
          else
            echo "âš ï¸  veveve.io content check: Could not verify PPC content"
          fi
          
          # Check HTTP status
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://veveve.io || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… veveve.io is accessible (HTTP $STATUS)"
          else
            echo "âŒ veveve.io failed (HTTP $STATUS)"
            exit 1
          fi

      - name: Test Domain Routing - veveve.dk
        run: |
          echo "Testing veveve.dk domain routing..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://veveve.dk || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… veveve.dk is accessible (HTTP $STATUS)"
          else
            echo "âŒ veveve.dk failed (HTTP $STATUS)"
            exit 1
          fi

      - name: Test Login Redirect
        run: |
          echo "Testing login redirect from veveve.dk..."
          
          REDIRECT=$(curl -sI https://veveve.dk/login 2>/dev/null | grep -i "location:" || echo "")
          if echo "$REDIRECT" | grep -qi "veveve.io/login"; then
            echo "âœ… Login redirect working (veveve.dk/login â†’ veveve.io/login)"
          else
            echo "âš ï¸  Login redirect check inconclusive"
            echo "   Redirect header: $REDIRECT"
          fi

      - name: Test API Endpoints
        run: |
          BASE_URL="${{ steps.urls.outputs.base_url }}"
          echo "Testing API endpoints at $BASE_URL..."
          
          # Test /api/test/ endpoint
          if curl -sf "$BASE_URL/api/test/" > /dev/null 2>&1; then
            RESPONSE=$(curl -s "$BASE_URL/api/test/")
            echo "API /test/ response: $RESPONSE"
            echo "âœ… API /test/ endpoint is working"
          else
            echo "âš ï¸  API /test/ endpoint not accessible"
          fi
          
          # Test backend health (if available)
          if curl -sf "$BASE_URL/api/health" > /dev/null 2>&1; then
            RESPONSE=$(curl -s "$BASE_URL/api/health")
            echo "Health check response: $RESPONSE"
            echo "âœ… Health endpoint is working"
          fi

      - name: Test SSL Certificates
        run: |
          echo "Testing SSL certificates..."
          
          for domain in veveve.io veveve.dk; do
            if echo | openssl s_client -servername $domain -connect $domain:443 2>/dev/null | grep -q "Verify return code: 0"; then
              echo "âœ… SSL certificate valid for $domain"
            else
              echo "âš ï¸  SSL certificate check for $domain inconclusive"
            fi
          done

      - name: Test HTTPS Redirect
        run: |
          echo "Testing HTTP to HTTPS redirects..."
          
          for domain in veveve.io veveve.dk; do
            REDIRECT=$(curl -sI "http://$domain" 2>/dev/null | grep -i "location:" || echo "")
            if echo "$REDIRECT" | grep -qi "https://"; then
              echo "âœ… HTTP to HTTPS redirect working for $domain"
            else
              echo "âš ï¸  HTTP redirect check for $domain inconclusive"
            fi
          done

      - name: Performance Check
        run: |
          BASE_URL="${{ steps.urls.outputs.base_url }}"
          echo "Testing response times..."
          
          START=$(date +%s%N)
          curl -sf "$BASE_URL" > /dev/null 2>&1
          END=$(date +%s%N)
          DURATION=$(( (END - START) / 1000000 ))
          
          echo "Frontend response time: ${DURATION}ms"
          
          if [ "$DURATION" -lt 3000 ]; then
            echo "âœ… Frontend response time acceptable (< 3s)"
          else
            echo "âš ï¸  Frontend response time slow (> 3s): ${DURATION}ms"
          fi

      - name: Generate Test Report
        run: |
          echo "## ðŸ§ª Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL**: ${{ steps.urls.outputs.base_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Domain routing (veveve.io, veveve.dk)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Login redirects" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSL certificates" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTPS redirects" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: All critical tests passed âœ…" >> $GITHUB_STEP_SUMMARY
